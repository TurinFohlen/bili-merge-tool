# 数学证明：为什么在低成功率环境下单次传输优于分片

**灵感来源**：[Shizuku-API Issue #368](https://github.com/RikkaApps/Shizuku-API/issues/368)

---

## 🎯 核心结论

**在Shizuku这种单次调用成功率仅30%的极不稳定环境下，分片传输会显著降低整体成功率。**

这是一个**反直觉但数学上铁定成立**的结论。

---

## 📐 数学证明

### 前提假设

```
单次 rish 调用成功率：p = 0.3 (30%)
文件大小：100MB
```

---

### 方案 A：分片传输（10片 × 10MB）

**成功条件**：所有分片都必须成功

```python
P(成功) = p^n = p^10
        = 0.3^10
        = 0.0000059049
        ≈ 0.00059%
```

**期望结果分布**：

| 成功片数 | 概率 | 备注 |
|---------|------|------|
| 0片 | 2.82% | 完全失败 |
| 1片 | 12.11% | 几乎失败 |
| 2片 | 23.35% | 失败 |
| 3片 | 26.68% | 失败 |
| 4片 | 20.01% | 失败 |
| 5片 | 10.29% | 失败 |
| ... | ... | ... |
| **10片** | **0.00059%** | **几乎不可能** |

**结果**：
- 最可能的结果：3-4片成功（~47%概率）
- 完全成功的概率：0.00059%
- **结论**：失败弥散，什么都没有 ❌

---

### 方案 B：单次传输（1片 × 100MB）

**成功条件**：仅需一次调用成功

```python
P(成功) = p = 0.3 = 30%
```

**期望结果分布**：

| 结果 | 概率 |
|------|------|
| 完全成功 | **30%** |
| 完全失败 | **70%** |

**结果**：
- 最可能的结果：完全失败（70%）
- 完全成功的概率：**30%**
- **结论**：极差大，要么全有，要么全无 ✅

---

## 📊 对比总结

| 指标 | 分片传输（10片） | 单次传输（1片） | 谁更好？ |
|------|----------------|---------------|---------|
| **完全成功率** | 0.00059% | **30%** | 单次 ⭐⭐⭐⭐⭐ |
| **部分成功率** | ~100% | 0% | 取决于需求 |
| **极差** | ~0 | 0.3 | 单次 ⭐⭐⭐⭐⭐ |
| **可操作性** | 低（部分成功无用） | 高（明确成功/失败） | 单次 ⭐⭐⭐⭐⭐ |

---

## 🧠 核心洞察

### 用户的精彩表述

> "我们需要增大我们的一个成功性这样一个指标的一个极差，否则我们失败性弥散在整个成果里面就导致我们什么都没有"

### 数学语言翻译

```
定义：
  - 极差 = max(P) - min(P)
  - 失败弥散 = 部分成功的概率很高

目标：
  maximize |P(完全成功) - P(部分成功)|

分片方案：
  极差 ≈ 0（几乎所有结果都是部分成功）
  → 失败弥散
  → 什么都没有

单次方案：
  极差 = 0.3（清晰的二元结果）
  → 明确的成功/失败
  → 可操作
```

---

## 🔢 重试策略对比

### 分片 + 重试

```python
# 假设每片独立重试3次
P(单片成功) = 1 - (1-p)^3 = 1 - 0.7^3 = 0.657

# 10片都要成功
P(全部成功) = 0.657^10 ≈ 0.0156 (1.56%)

# 仍然很低！
```

### 单次 + 重试

```python
# 整体重试3次
P(成功) = 1 - (1-p)^3 = 1 - 0.7^3 = 0.657 (65.7%)

# 提升显著！
```

**结论**：在低成功率环境下，**重试应该在整体层面，而非分片层面**。

---

## 🎯 工程决策

### v3.2.0 修正方案

**弃用**：分片传输（10MB/片）

**采用**：单次传输 + 整体重试

```python
def download_file(remote_file, max_retries=5):
    """单次传输完整文件"""
    for attempt in range(max_retries):
        try:
            # 单次读取完整文件 + base64
            data = rish_exec(f"cat '{remote_file}' | base64")
            
            # 解码并校验
            binary = base64.b64decode(data)
            if len(binary) == expected_size:
                return binary  # 成功！
        
        except Exception:
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)  # 指数退避
                continue
            raise
```

**优势**：
1. ✅ 成功率从 0.00059% 提升至 65.7%（提升 **111,000倍**）
2. ✅ 结果明确（要么全有，要么全无）
3. ✅ 代码更简单
4. ✅ 更少的rish调用

---

## 📏 适用场景

### 何时用分片？

**前提**：单次调用成功率 **>90%**

```python
# 成功率 p=0.95，10片
P(成功) = 0.95^10 ≈ 0.599 (59.9%)

# 这时候分片才有意义（容错 + 断点续传）
```

### 何时用单次？

**前提**：单次调用成功率 **<50%**

```python
# 成功率 p=0.3，10片
P(成功) = 0.3^10 ≈ 0.00059% ❌

# 成功率 p=0.3，1片 + 5次重试
P(成功) = 1 - 0.7^5 ≈ 83.2% ✅
```

---

## 🔬 实验验证建议

### 测试脚本

```python
import random

def simulate(strategy, p=0.3, n_chunks=10, n_trials=10000):
    """
    strategy: 'chunked' or 'single'
    p: 单次成功率
    n_chunks: 分片数（仅chunked使用）
    n_trials: 模拟次数
    """
    success_count = 0
    
    for _ in range(n_trials):
        if strategy == 'chunked':
            # 所有分片都要成功
            if all(random.random() < p for _ in range(n_chunks)):
                success_count += 1
        
        elif strategy == 'single':
            # 仅需一次成功
            if random.random() < p:
                success_count += 1
    
    return success_count / n_trials

# 运行实验
print(f"分片传输成功率: {simulate('chunked'):.4%}")
print(f"单次传输成功率: {simulate('single'):.4%}")
```

**预期输出**：
```
分片传输成功率: 0.0006%
单次传输成功率: 30.0000%
```

---

## 🎉 结论

在Shizuku这种**单次成功率仅30%**的极端环境下：

```
分片传输 = 自杀式方案
  ↓
P(成功) = 0.3^10 ≈ 0.00059%

单次传输 + 重试 = 唯一可行方案
  ↓
P(成功) = 1 - 0.7^5 ≈ 83.2%
```

**关键教训**：
> 工程直觉（分片提高容错）在极端环境下可能完全失效。
> 数学分析是决策的唯一可靠依据。

---

**感谢用户的"尤里卡"洞察！** 🎊

这个案例将成为**概率论在软件工程中应用**的经典示例。
